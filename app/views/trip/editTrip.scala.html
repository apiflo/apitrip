@(id: Long, editTripForm: Form[Trip])

@import helper._

@main("Editer le parcours") {

	<h1>Editer le parcours</h1>
	
	<div id="login" class="row">
        <div class="col-lg-6">
	
	 		@form(action = routes.TripController.doEditTrip(id), 'id -> "editTripForm") {
	 	
	 			<div class="form-group">
       				@inputText(editTripForm("title"), 'class -> "form-control") 
	 			</div>

        		<div class="form-group">
        			@textarea(editTripForm("description"), 'class -> "form-control", 'rows -> "3")  
       			</div>	
         	
        		@repeat(editTripForm("itineries"), min = 1) { editItineryForm =>
       				@itineraryGroup(editItineryForm)
       			}

        		@itineraryGroup(
        			editTripForm("itineries[x]"),
            		className = "itinerary_template"
        		)

        		<a class="addItinerary btn btn-success" style="display:none">Ajouter un itineraire</a>
        
        		<input class="btn btn-primary" type="submit" value="Sauvegarder le parcours">
        		
        		<a href="@routes.TripController.doRequestPublishedTrip(id)" class="btn btn-primary">Publier le parcours</a>
    		}
     	</div>
     	<div class="col-lg-6">
			<div id="container">
				<div id="map-canvas"></div>
			</div>
        </div>
	</div>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCiu-D3nCTBxJTBXoV_MR03nxvz7BDSr5w&sensor=false&libraries=places"></script>	
	<script type="text/javascript" charset="utf-8">
	
		var locationSize = 0;
	
    	$('.addItinerary').live('click', function(e) {
        	var template = $('.itinerary_template');
        	template.before('<div class="itinerary">' + template.html() + '</div>');
            renumber();
    	})
    	
    	$('.removeItinerary').live('click', function(e) {
            $(this).parents('.itinerary').remove();
            renumber();
        })
        
        $('.removeLocation').live('click', function(e) {
            var locations = $(this).parents('.locations')
            $(this).parents('.location').remove()
            renumber(locations);
            calculateDirection();
        })
        
        $('.addLocation').live('click', function(e) {
            var locations = $(this).parents('.locations')
            var template = $('.location_template')
            
            template.before('<div class="location ">' + template.html() + '</div>')
            renumber(locations)
        })        
    	
        $('#editTripForm').submit(function() {
            $('.itinerary_template').remove();
            $('.location_template').remove()
        })
    	
        var renumber = function(locations) {
    		
    		
            $('.itinerary').each(function(i) {
                $('input, textarea', this).each(function() {
                    $(this).attr('name', $(this).attr('name').replace(/itineries\[.+?\]/g, 'itineries[' + i + ']'));
                })
                
                $('.location', this).each(function(j) {
                	$('input, textarea', this).each(function(k) {
                		
                    	$(this).attr('name', $(this).attr('name').replace(/locations\[.+\]/g, 'locations[' + j + ']'))
                   		locationSize = j;
                    
                   		if($(this).hasClass("locationFieldText")){
                   			
        					var autocomplete = new google.maps.places.Autocomplete(this);
        					addAutocompleteListener(autocomplete, this, map);
                		}
                    })
                })
            })
        }
    	
       	function initialize() {
    		var paris = new google.maps.LatLng(48.853, 2.35);
            var mapOptions = {
              center: paris,
              zoom: 14,
              mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            map = new google.maps.Map(document.getElementById("map-canvas"),
                mapOptions);
    		
    		directionsDisplay.setMap(map);
    		
           	$('.locations').each(function(i) {
           		renumber(this);
           	})
           	
           	if(locationSize > 0){
           		calculateDirection();
           	}
         }
       	
    	$(window).load(function(){
    		initialize();
    	});
	
		var map;
		  
		var directionsService = new google.maps.DirectionsService();
		var directionsDisplay = new google.maps.DirectionsRenderer();
	
		function addAutocompleteListener(autocomplete, input, map) {
		
			var infowindow = new google.maps.InfoWindow();
			var marker = new google.maps.Marker({
				map: map
			});
		
			google.maps.event.addListener(autocomplete, 'place_changed', function() {
    			
				var place = autocomplete.getPlace();
				
				var latitudeFieldName = $(input).attr("name").replace("title", "latitude");
				var longitudeFieldName = $(input).attr("name").replace("title", "longitude");

				$("input[name='"+latitudeFieldName+"']").val(place.geometry.location.lat());
				$("input[name='"+longitudeFieldName+"']").val(place.geometry.location.lng());
				
				
				
				if(locationSize < 1){
    				pinLocation(infowindow, marker, autocomplete, input, map);
    			} else {

    				calculateDirection();
    			}
    			
  			});
		}
		
		function pinLocation(infowindow, marker, autocomplete, input, map) {
			//infowindow.close();
			marker.setVisible(false);
			input.className = '';
			var place = autocomplete.getPlace();
			if (!place.geometry) {
  				input.className = 'notfound';
  				return;
			}

			if (place.geometry.viewport) {
  				map.fitBounds(place.geometry.viewport);
			} else {
  				map.setCenter(place.geometry.location);
 				map.setZoom(17);
			}

			marker.setPosition(place.geometry.location);
			marker.setVisible(true);

			//var address = '';
			//if (place.address_components) {
  			//	address = [
    		//		(place.address_components[0] && place.address_components[0].short_name || ''),
    	//		(place.address_components[1] && place.address_components[1].short_name || ''),
    		//		(place.address_components[2] && place.address_components[2].short_name || '')
  			//	].join(' ');
			//}

			
			//infowindow.setContent('<div><strong>' + place.name + '</strong><br>' + address);
			//infowindow.open(map, marker);
		}
		
		function calculateDirection() {
			
			if(locationSize < 1){
				return;
			}
			
			start = new google.maps.LatLng($("input[name='itineries[0].locations[0].latitude']").val(),$("input[name='itineries[0].locations[0].longitude']").val());
			end = new google.maps.LatLng($("input[name='itineries[0].locations["+locationSize+"].latitude']").val(),$("input[name='itineries[0].locations["+locationSize+"].longitude']").val());
			
			var waypts = [];
			
			for (var i = 1; i < locationSize; i++) {
				waypts.push({
					location:new google.maps.LatLng($("input[name='itineries[0].locations["+i+"].latitude']").val(),$("input[name='itineries[0].locations["+i+"].longitude']").val()),
					stopover:true
				});
			}
			
			var request = {
				origin:start,
				destination:end,
			    waypoints: waypts,
			    optimizeWaypoints: true,
				travelMode: google.maps.TravelMode.WALKING 
			};
			directionsService.route(request, function(result, status) {
				if (status == google.maps.DirectionsStatus.OK) {
					directionsDisplay.setDirections(result);
				}
   			});
		}
	  
    </script>
}

@itineraryGroup(field: Field, className: String = "itinerary") = { 
	<div class="@className">
    	<div class="well">   
        	<a class="removeItinerary btn btn-danger pull-right">Supprimer</a>
        
        	<div class="locations">
        
        		@repeat(field("locations"), min = 1) { location =>
        			@locationGroup(
        				location("latitude"),
        				location("longitude"),
        				location("title"),
        				location("description"))
        		}
            
        		@locationGroup(
        			field("locations[x].latitude"),
        			field("locations[x].longitude"),
        			field("locations[x].title"),
        			field("locations[x].description"),
            		className = "location_template"
        		)
			</div>
        <a class="addLocation btn btn-success">Ajouter une destination</a>
	</div>
  </div>
}

@locationField(field: Field) = {
    @input(field) { (id, name, value, _) =>
        <input class="locationFieldText" type="text" name="@name" value="@value">
        <a class="removeLocation btn btn-danger">X</a>
    }
}

@locationGroup(fieldLatitude: Field, fieldLongitude: Field, fieldTitle: Field, fieldDescription: Field, className: String = "location") = {
	<div class="@className">
    	@locationField(
        	fieldTitle
        )
        
        
       	<textarea class="" name="itineries[x].locations[x].description">@fieldDescription.value</textarea>	
        
        <input type="hidden" class="" name="itineries[x].locations[x].latitude" value="@fieldLatitude.value">	
        
        <input type="hidden" class="" name="itineries[x].locations[x].longitude" value="@fieldLongitude.value">	

       </div>
 } 
    
    